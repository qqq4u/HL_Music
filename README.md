# HighLoad сервис музыкального стриминга

## Часть 1. Тема и целевая аудитория

### Тема курсовой работы - **"Проектирование высоконагруженного музыкального стримингового сервиса"**
Примером для разработки послужили одни из главных музыкальных стриминговых сервисов  - [VK Музыка](https://music.vk.com/) и [Яндекс.Музыка](https://music.yandex.com/)

### Ключевой функционал сервиса, необходимый для MVP
- Регистрация и авторизация
- Создание страницы автора
- Загрузка треков и создание плейлистов со стороны пользователя
- Разбиение треков по жанрам и другим вспомогательным категориям
- Стриминг аудио

### Ключевые продуктовые решения
- Доступность части основного функционала сервиса без интернета
- Поддержка высококачественного аудио
- Сбор статистики по прослушиваниям для исполниетелей
- Создание персональных рекомендаций для пользователя

### Целевая аудитория сервиса
- 44 миллиона [**MAU**](https://vk.company/ru/investors/ir_blog/11472/)
- 14 миллионов [**DAU**](https://vk.company/ru/investors/ir_blog/11472/)
- Средний пользователь проводит на сервисе около [4-х часов](https://er10.kz/obzory/statistika-jandeksa-v-2022-godu)
- На возрастную группу 18-24 года приходится [45%](https://marketsplash.com/music-streaming-statistics/#:~:text=age%20group%20represents-,45,-%25%20of%20all%20music) всех пользователей сервисов потоковой музыки

## Часть 2. Расчет нагрузки

### Аудитория и объём данных
- Среднее время прослушивания в месяц - [**27 часов**](https://thegirl.ru/articles/v-yandeks-muzyke-poschitali-chi-treki-v-rossii-slushali-bolshe-vsego-v-2022-godu/), исходя из этого:
- Среднее время прослушивания за день - **54 минуты**
- Количество треков на платформе - [**60 миллионов**](https://re-store.ru/blog/sravneniya/music-services-in-russia/)
- **1 час** музыки в среднем весит примерно [**115 МБайт**](https://yandex.ru/support/music-app-android/offline/save-music.html), следовательно **1 минута** - **2 МБайта**
- **Длительность** среднего трека - **3 минуты**
- Средний **вес аудио** ~ **6МБ**
- Средний **вес обложки** альбома ~150 КБайт
- Песня в плейлисте(маленькая картинка + название) ~ 9 Кб.
- Конкретная песня(большая картинка + название + вес аудио) ~ 6200 Кб
  
### Рассчёт RPS
Представим стандартный кейс использования музыкального сервиса за целый день:
- Открытие своего списка песен, подгрузка ~20 названий и картинок (10 раз)
- Открытие конкретного плейлиста, в среднем - 30 песен(3 раза)
- Открытие альбома, в среднем - 12 песен (5 раз)
- Поиск песни, в среднем - выдача 10 треков (5 раз)
- Загрузка трека для прослушивания (54/3 = 18 раз)

Перемножив всё на количество пользоваталей в день, получаем **средний RPS** = (7+3+5+5+18)*14000000/86400 = **6158**.
Возьмём увеличение нагрузки в пиках до значений, в два раза превышающих стандартные, тогда получаем ~ **12300 RPS в пике**

### Рассчёт сетевой нагрузки

**Трафик на выгрузку**
Исходя из приведённых выше данных посчитаем нагрузку на сеть:
- Получение списка песен: 20 * 10 * 9КБ  = 1800000 КБайт
- Открытие плейлиста(большая обложка + треки):  3 * (30 * 9КБ + 150КБ) = 1260 КБайт
- Открытие альбома(большая обложка + треки): 5 * (12 * 9КБ + 150КБ) = 1290 КБайт
- Поиск песни: 5 * 10 * 9КБ = 450 КБайт
- Загрузка треков: 18 * 6200КБ = 111 МБайт

Перемножим на ежедневное количество пользователей, получим **нагрузку на сеть**:
(111600+450+1290+1260+1800)*14000000 = **1629600 ГБайт/день** = **13036800 ГБит/день** или **150ГБит/секунду**
Соответсвенно, **Пиковая нагрузка** = **300ГБит/секунду**

**Трафик на загрузку**
Ежедневно на платформу будут загружать [20000](https://xmldatafeed.com/spotify-stats-2022-fakty-dannye-polzovateli-ispolzovanie-i-chasy-proslushivaniya/#Skolko_novyh_pesen_ezednevno_zagruzaetsa_na_Spotify) новых треков
Возьмём в рассчёт, что примерно 80% треков имеют разные обложки, тогда получим ежедневный объём данных на загрузку:
20000 * (6МБ + 150КБ * 0.8) = 2520000МБ = **123 ГБайта/день или 1425КБайт/секунду**, или **2850КБайт/секунду в пике**

Получим таблицу:
### Технические метрики
|          | RPS  |  Пиковый RPS | Нагрузка на сеть | Пиковая нагрузка на сеть |
|----------|------|--------------|------------------|--------------------------|
| Выгрузка | **6158** | **12 316**       | **150ГБит/секунду**  | **300ГБит/секунду**          |
| Загрузка | **0.1** | **0.2**          | **1425КБайт/секунду**  | **2850КБайт/секунду**         |
| Всего    | **6159** | **12 318**      | **151ГБит/секунду** | **302ГБит/секунду**        |

## Часть 3. Балансировка и расположение ЦОДов

### Расположение целевой аудитории

Целевая аудитория сервиса расположениа в России и странах СНГ. 
Взглянем на карту плотности населения Росиии:
![image](https://github.com/qqq4u/HL_Music/assets/44649392/9b63c08b-a173-47d0-90b4-631da7a7643d)

Исходя из неё, расположим наши ЦОДы в основных крупных городах, которые являются центрами административных округов, а именно:
* **Москва**
* **Санкт-Петербург**
* **Краснодар**
* **Красноярск**

Сервер на дальнем востоке отсутствует ввиду неэффективности, решать будем префетчем контента для пользователей оттуда.

Для балансировки будем использовать latency-based resolver Amazon Route 53(мб нельзя если не хостишься у них же) ИЛИ аналоги. Поскольку в нашей реализации некоторые ЦОДы находятся в одной DNS зоне, будем использовать BGP Anycast балансировку для того, чтобы резолвить IP-шники.

## Часть 4. Локальная балансировка

### Инструменты локальной балансировки
Для локальной балансировки выберем надёжный и зарекомендовавший себя NGINX. Данный L7-балансировщик очень хорош в работе со статикой, как и NGINX, а поскольку наш сервис завязан на передаче статических файлов, это очень полезное свойство. Для сжатия статики воспользуемся форматом файлов gzip, с которыми nginx прекрасно работает.

Для более быстрой и удобной конфигурации, а так же улучшенного балансирования межконтейнерного взаимодействия, во внутренних сервисах, где нет необходимости в использовании статики и реализованы простые HTTP-задачи: логи, авторизация и т.д., мы будем использовать ENVOY.

Для удобства регулировки, балансировки и администрирования наш сервис будет находиться внутри kubernetes инфраструктуры.

### Схема отказоустойчивости

Поскольку L7-балансировщики проводят healthcheck в автоматическом режиме, то это снимает с нас часть задач. Наличие ENVOY в нашей системе поможет нам быстрее конфигурировать важные сервисы в критических ситуациях. Те сервисы, что используют nginx, будут более сложны в экстренной помощи, но всё же открыты.

Отказоустойчивость же, исходя из вышесказанного и дополнений, будет заключаться в использовании:
- grafana+node-exporter+prometheus для алёртинга и статусчеков
- kubernetes для балансировки нагрузки и автоматического дирижирования подами в случае изменения плато нагрузки
- дополнительных источников электричества на уровне датацентров
- дежурных системных администраторов


## Часть 5. Масштабирование базы данных

### Логическая схема базы данных
![DB_log](https://github.com/qqq4u/HL_Music/assets/44649392/0a19df4c-c752-4e9b-bb13-5c215f42c3c2)

### Физическая(денормализованная) схема базы данных
![DB_phiz](https://github.com/qqq4u/HL_Music/assets/44649392/d0b63447-0a0f-4633-8645-52caa437be4c)

(избегаем джойнов)
 * tracks: +artist_name
 * albums: +creator_name, +is_official
 * tracks_histories: +track_name, +track_artist_name
 * tracks_collections: +track_name, `+track_artist_name

### Рассчёт занимаемого дискового пространства 

Посчитаем количество записей в каждой таблице:
* Пользователей: 60 млн. - `users`
* Треков: 65 млн. - `tracks`
* Исполнителей: 2 млн. - `artists`
* Сессий: 0,1% от пользователей: 600 тыс. - `sessions`
* Альбомов: 4 на исполнителя и по 2 на пользователя: 2 млн * 4 + 4 млн * 2 = 16 млн. - `albums`
* 2 млн * 4 = 8 млн. - `albums_to_artists`
* 60 млн * 2 = 120 млн. - `albums_to_users`
* Пусть у 1-ой из 7 песен 2 исполнителя, а не 1. Тогда: 65 млн / 7 * 8 = 74,2 млн. - `tracks_to_artists`
* Пусть в альбоме исполнителя в среднем [12 треков](https://ru.wikipedia.org/wiki/Музыкальный_альбом), а в альбоме пользователя в среднем 30 треков. Тогда: 8 млн * 12 + 65 млн * 30 = 2 млрд. - `albums_to_tracks`
* Пусть добавленных аудио у пользователя в среднем 200. Тогда 65 млн * 200 = 13 млрд. - `tracks_collections`
* Мы будем хранить историю прослушиваний нашего сервиса 3 дня. Средний пользователь в день случает 18 треков. За 3 дня на всех будет(исходя из DAU): 14 млн * 18 * 3 = 336млн  - `tracks_histories`

Исходя из средних размеров данных в БД 
```
int - 4Б
text - 20 символов в utf-8: 20 * 4Б = 80Б 
bool - 1Б
```


Таблица           | Строк (млн) | Данных на строку (Б)         | Всего данных (МБ) |
------------------| ------------| -----------------------------| ------------------|
users             | 60          | 1 * 4 + 3 * 80 + 1 * 4 = 248 | 14 880
tracks            | 65          | 2 * 4 + 7 * 80 = 568         | 36 920
artists           | 2           | 2 * 4 + 3 * 80 = 248         | 492
sessions          | 0,6         | 1 * 4 + 1 * 80 = 84          | 50,4
albums            | 16          | 1 * 4 + 6 * 80 + 1 * 4 = 488 | 7 808
albums_to_artists | 8           | 2 * 4 = 8                    | 64
albums_to_users   | 120         | 2 * 4 = 8                    | 61
tracks_to_artists | 74,2        | 2 * 4 = 8                    | 960
albums_to_tracks  | 2000        | 2 * 4 = 8                    | 16 000
tracks_collection | 13000       | 2 * 4 + 2 * 80 = 168         | 2 184 000
tracks_histories  | 336         | 2 * 4 + 2 * 80 = 168         | 56 338

### Подсчитаем итоговые данные:

**Пользователи:**
14880 + 36920 + 492 + 50,4 + 7808 + 64 + 61 + 960 + 16000 + 2184000 + 56338 = 2 317 573,4 МБ = 2,31 ТБ данных пользователей 

**Аудио**
  * 128kbps = 3 мин * (85 МБ / 60 мин) = 4,25 МБ
  * 320kbps = 3 мин * (145 МБ / 60 мин) = 7,25 МБ
    
Тогда суммарно:
56 млн * (4,25 + 7,25) = 747,5 ТБ аудио

**Картинки(альбомы и исполнители)**

Имеем следующий вес картинок:
  * 200х200px = 30кБ
  * 50х50px = 2кБ
  * 1000х1000px = 100кБ
    
Тогда суммарно:
16 млн * (30 + 2 + 100) + 2 млн * (30 + 100) = 2,4 ТБ изображений
  
